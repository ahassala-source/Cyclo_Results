<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Résultats ZwiftPower (local)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f9fafb; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.6rem; text-align: left; }
    th { background: #eee; }
    td.num { text-align: right; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h1>Résultats ZwiftPower</h1>
  <div id="content">Chargement...</div>

  <script>
    // Convertit un temps texte/numérique en secondes (garde millisecondes)
    function toSeconds(time) {
      if (time == null) return null;
      const t = (typeof time === 'string') ? time.trim() : time;
      if (t === '' || t === '--' || (typeof t === 'string' && /DNF|DSQ/i.test(t))) return null;

      if (typeof t === 'number') return Number.isFinite(t) ? t : null;

      if (typeof t === 'string') {
        const parts = t.split(':');
        const parsePart = (s) => (s == null || s === '') ? NaN : Number(s);
        let h = 0, m = 0, s = 0;

        if (parts.length === 3) {
          h = parsePart(parts[0]);
          m = parsePart(parts[1]);
          s = parseFloat(parts[2]);
        } else if (parts.length === 2) {
          m = parsePart(parts[0]);
          s = parseFloat(parts[1]);
        } else if (parts.length === 1) {
          s = parseFloat(parts[0]);
        } else {
          return null;
        }
        if ([h, m, s].some(x => Number.isNaN(x))) return null;
        return h * 3600 + m * 60 + s;
      }
      return null;
    }

    // Formatte un temps (en secondes) de façon lisible (1h 2m 5s)
    function formatTimeGun(time) {
      if (time == null || time === '' || time === '--' || (typeof time === 'string' && /DNF|DSQ/i.test(time))) return '';
      if (typeof time === 'string' && time.includes(':')) return time;

      const total = Number(time);
      if (!Number.isFinite(total)) return String(time);

      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = Math.floor(total % 60);
      const parts = [];
      if (h > 0) parts.push(`${h}h`);
      if (m > 0 || h > 0) parts.push(`${m}m`);
      parts.push(`${s}s`);
      return parts.join(' ');
    }

    // Formatte la différence (avec 3 décimales, masque si 0)
    function formatDiff(deltaSeconds) {
      if (deltaSeconds == null || !Number.isFinite(deltaSeconds)) return '';

      const rounded = Math.abs(deltaSeconds);
      if (rounded < 0.001) return ''; // rien si +0.000s

      const sign = deltaSeconds >= 0 ? '+' : '-';
      const v = rounded;
      const h = Math.floor(v / 3600);
      const m = Math.floor((v % 3600) / 60);
      const sec = v - (h * 3600 + m * 60);

      if (h > 0) {
        const secStr = (sec < 10 ? '0' : '') + sec.toFixed(3);
        return `${sign}${h}h ${m}m ${secStr}s`;
      } else if (m > 0) {
        const secStr = (sec < 10 ? '0' : '') + sec.toFixed(3);
        return `${sign}${m}m ${secStr}s`;
      } else {
        return `${sign}${sec.toFixed(3)}s`;
      }
    }

    fetch('5106370_view.json')
      .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
      .then(data => {
        const results = data.data || data || [];
        if (!Array.isArray(results) || results.length === 0) {
          document.getElementById('content').textContent = "Aucun résultat trouvé.";
          return;
        }

        // Trouver le meilleur temps (min) par catégorie
        const bestByCat = {};
        for (const r of results) {
          const cat = r.age;
          const secs = toSeconds(r.time_gun);
          if (cat && secs != null) {
            if (bestByCat[cat] == null || secs < bestByCat[cat]) bestByCat[cat] = secs;
          }
        }

        // Construire le tableau
        let html = `
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Catégorie</th>
                <th>Nom</th>
                <th class="num">Temps (Gun)</th>
                <th class="num">Diff</th>
              </tr>
            </thead>
            <tbody>
        `;

        results.forEach((r, i) => {
          const cat = r.age || '';
          const secs = toSeconds(r.time_gun);
          const best = bestByCat[cat];
          const diff = (secs != null && best != null) ? (secs - best) : null;

          html += `
            <tr>
              <td>${i + 1}</td>
              <td>${cat}</td>
              <td>${r.name || ''}</td>
              <td class="num">${formatTimeGun(r.time_gun)}</td>
              <td class="num">${formatDiff(diff)}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        document.getElementById('content').innerHTML = html;
      })
      .catch(err => {
        console.error('Erreur JSON :', err);
        document.getElementById('content').textContent =
          'Erreur de chargement du fichier JSON (' + err.message + ')';
      });
  </script>
</body>
</html>

